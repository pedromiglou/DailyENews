name: Deploy to cluster

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v2
    - name: Build docker images
      env:
        PUBLIC_URL: /app
        REACT_APP_API_URL: http://api.dailyenews.k3s
      run: |
        docker build . --file Dockerfiles/pythonbase -t pythonbase
        docker build . --file Dockerfiles/server -t registry.deti:5000/gic2/server
        docker build . --file Dockerfiles/worker -t registry.deti:5000/gic2/worker
        docker build . --file Dockerfiles/client -t registry.deti:5000/gic2/client --build-arg PUBLIC_URL=$(PUBLIC_URL) --build-arg REACT_APP_API_URL=$(REACT_APP_API_URL)
    - name: Push docker images
      run: |
        docker push registry.deti:5000/gic2/server
        docker push registry.deti:5000/gic2/worker
        docker push registry.deti:5000/gic2/client